package enginuity.logger.innovate.plugin;

import enginuity.io.connection.ConnectionProperties;
import enginuity.io.connection.SerialConnection;
import enginuity.io.connection.SerialConnectionImpl;
import enginuity.logger.ecu.exception.SerialCommunicationException;
import static enginuity.util.HexUtil.asHex;
import static enginuity.util.ParamChecker.checkNotNull;
import static enginuity.util.ParamChecker.checkNotNullOrEmpty;
import static enginuity.util.ThreadUtil.sleep;

public final class Lc1Connection implements InnovateConnection {
    private final long sendTimeout;
    private final SerialConnection serialConnection;

    public Lc1Connection(ConnectionProperties connectionProperties, String portName) {
        checkNotNull(connectionProperties, "connectionProperties");
        checkNotNullOrEmpty(portName, "portName");
        this.sendTimeout = connectionProperties.getSendTimeout();

        // Use TestSSMConnectionImpl for testing!!
        serialConnection = new SerialConnectionImpl(connectionProperties, portName);
//        serialConnection = new TestSSMConnectionImpl(connectionProperties, portName);
    }

    public byte[] read() {
        try {
            byte[] response = new byte[6];
            serialConnection.readStaleData();
            long timeout = sendTimeout;
            while (serialConnection.available() < response.length) {
                sleep(1);
                timeout -= 1;
                if (timeout <= 0) {
                    byte[] badBytes = new byte[serialConnection.available()];
                    serialConnection.read(badBytes);
                    System.out.println("Bad response (read timeout): " + asHex(badBytes));
                    break;
                }
            }
            serialConnection.read(response);
            return response;
        } catch (Exception e) {
            close();
            throw new SerialCommunicationException(e);
        }
    }

    public void close() {
        serialConnection.close();
    }
}

/*
Adding logger:   LC-1
Read bytes = B2825313012EB2825313012EB2825313012EB2825313012EB2825313012EB2825313013EB2825313013EB2825313013EB2825313013EB2825313013EB2825313014AB2825313014AB2825313014AB2825313014AB2825313014AB28253130158B28253130158B28253130158B28253130158B28253130158B28253130162B28253130162B28253130162B28253130162B28253130162B28253130171B28253130171B28253130171B28253130171B28253130171B2825313017EB2825313017EB2825313017EB2825313017EB2825313017EB28253130208B28253130208B28253130208B28253130208B28253130208B28253130218B28253130218B28253130218B28253130218B28253130218B28253130226B28253130226B28253130226B28253130226B28253130226B2825313022EB2825313022EB2825313022EB2825313022EB2825313022EB28253130237B28253130237B28253130237B28253130237B28253130237B28253130244B28253130244B28253130244B28253130244B28253130244B28253130251B28253130251B28253130251B28253130251B28253130251B2825313025CB2825313025CB2825313025CB2825313025CB2825313025CB28253130261B28253130261B28253130261B28253130261
Stale data read: B2
Read bytes = 8253130261B2825313026FB2825313026FB2825313026FB2825313026FB2825313026FB2825313027BB2825313027BB2825313027B
Read bytes = B2825313027BB2825313027BB28253130308B28253130308B28253130308B28253130308B28253130308
Read bytes = B28253130312B28253130312B28253130312B28253130312B28253130312B2825313031CB2825313031CB2825313031CB2825313031CB2825313031CB28253130327B28253130327B28253130327B28253130327B28253130327B2825313032AB2825313032A
Read bytes = B2825313032AB2825313032AB2825313032AB28253130339B28253130339B28253130339B28253130339B28253130339B28253130342B28253130342B28253130342B28253130342B28253130342B2825313034AB2825313034AB2825313034AB2825313034AB2825313034AB28253130358B28253130358B28253130358
Read bytes = B28253130358B28253130358B2825313035DB2825313035DB2825313035DB2825313035DB2825313035DB28253130366B28253130366B28253130366B28253130366B28253130366B28253130372B28253130372B28253130372B28253130372B28253130372B28253130378B28253130378B28253130378B28253130378B28253130378B2825313037FB2825313037FB2825313037FB2825313037F
Read bytes = B2825313037F
Read bytes = B28253130406B28253130406B28253130406B28253130406B28253130406B28253130408B28253130408
Read bytes = B28253130408B28253130408B28253130408B28253130411B28253130411B28253130411B28253130411B28253130411B28253130417
Read bytes = B28253130417B28253130417B28253130417B28253130417B28253130417B28253130417B28253130417B28253130417B28253130417B28253130424B28253130424B28253130424B28253130424B28253130424B28253130424B28253130424B28253130424B28253130424B28253130424B2825313042DB2825313042DB2825313042DB2825313042DB2825313042DB28253130438
Read bytes = B28253130438B28253130438B28253130438B28253130438B2825313043BB2825313043BB2825313043BB2825313043BB2825313043BB2825313043BB2825313043BB2825313043BB2825313043BB2825313043BB28253130442B28253130442B28253130442B28253130442
Read bytes = B28253130442B28253130449B28253130449B28253130449B28253130449B28253130449B2825313044BB2825313044BB2825313044BB2825313044BB2825313044BB28253130450B28253130450B28253130450B28253130450
Read bytes = B28253130450
Read bytes = B28253130454B28253130454B28253130454B28253130454B28253130454
Read bytes = B28253130457B28253130457B28253130457B28253130457B28253130457B2825313045EB2825313045EB2825313045EB2825313045EB2825313045EB2825313045EB2825313045E
Read bytes = B2825313045EB2825313045EB2825313045EB2825313045EB2825313045EB2825313045EB2825313045EB2825313045EB28253130460B28253130460B28253130460B28253130460B28253130460B28253130465B28253130465B28253130465B28253130465B28253130465B2825313046AB2825313046AB2825313046AB2825313046AB2825313046AB2825313046DB2825313046DB2825313046DB2825313046DB2825313046DB2825313046DB2825313046DB2825313046D
Stale data read: B2
Read bytes = 825313046DB2825313046DB28253130474B28253130474B28253130474B28253130474B28253130474B28253130474B28253130474B28253130474B28253130474B28253130474B2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB2825313047CB28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B28253130503B2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050B
Read bytes = B2825313050BB2825313050BB2825313050BB2825313050BB2825313050BB2825313050B
Read bytes = B2825313050BB28243131F62B28243131F40B28243131F31B28243131F24B28243131F1B
Read bytes = B28243131F08B28243131F07B28243131E6CB28243131E65B28243131E65B28243131E4AB28243131E47B28243131E44B28243131E25B28243131E32B28243131E16B28243131E02B28243131E03B28243131E00B28243131D76B28243131D5F
Read bytes = B28243131D59B28243131D41B28243131D46B28243131D3AB28243131D1AB28243131D26B28243131D22B28243131D07
Read bytes = B28243131D09
Read bytes = B28243131C7FB28243131C5FB28243131C6EB28243131C55B28243131C56B28243131C45B28243131C3FB28243131C42B28243131C21B28243131C24B28243131C16B28243131C08B28243131C04B28243131B75B28243131B74B28243131B6CB28243131B59B28243131B55B28243131B54B28243131B42B28243131B3BB28243131B3DB28243131B1CB28243131B1FB28243131B15B28243131B03B28243131B02B28243131A7AB28243131A6BB28243131A66B28243131A60B28243131A59B28243131A4CB28243131A47B28243131A2EB28243131A39B28243131A33B28243131A1CB28243131A20B28243131A14B2824313197FB28243131A07B2824313197AB28243131965B28243131969B28243131960B28243131952B2824313194FB2824313193FB28243131944B2824313193BB2824313192BB28243131927B2824313191CB28243131917B2824313190AB2824313190AB28243131876B28243131870B2824313186AB28243131866B28243131855B28243131852B28243131851B28243131846B28243131836B28243131832B2824313181E
Read bytes = B28243131827B28243131814B2824313180AB2824313180AB2824313177FB28243131771B28243131773B28243131761B28243131764B2824313175DB28243131749B28243131740B28243131738B2824313172F
Read bytes = 
*/

